<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OAuth2 links page</title>
    <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js"></script>
</head>
<body>
    <ul id="list">
        <li>Loading OAuth2 providers...</li>
    </ul>

    <script type="module">
        import PocketBase from "https://cdn.jsdelivr.net/gh/pocketbase/js-sdk@master/dist/pocketbase.es.mjs"

        const pb          = new PocketBase("http://127.0.0.1:8090");
        const redirectURL = "http://127.0.0.1:8090/redirect.html";

        const authMethods = await pb.collection("users").listAuthMethods();
        const providers   = authMethods.oauth2?.providers || [];
        const listItems   = [];

        for (const provider of providers) {
            const $li = $(`<li><a>Login with ${provider.name}</a></li>`);

            $li.find("a")
                .attr("href", provider.authURL + redirectURL)
                .data("provider", provider)
                .click(function () {
                    // store provider's data on click for verification in the redirect page
                    localStorage.setItem("provider", JSON.stringify($(this).data("provider")));
                });

            listItems.push($li);
        }

        $("#list").html(listItems.length ? listItems : "<li>No OAuth2 providers.</li>");
    </script>
</body>
</html>
