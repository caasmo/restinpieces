<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-5" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>API Endpoints</title>
    <link rel="stylesheet" href="/css/restinpieces.css" />
  </head>
  <body>
    <div class="endpoints-header">
      <h1>API Endpoints</h1>
      <div class="endpoints-nav">
        <a href="/login.html">Login</a>
        <a href="/dashboard.html">Dashboard</a>
        <a href="/logout.html">Logout</a>
      </div>
    </div>

    <div id="auth-status" class="auth-status">
      <span id="auth-text">Checking auth status...</span>
    </div>

    <button id="get-endpoints-btn" class="refresh-btn">
      Refresh Endpoints
    </button>

    <div class="endpoints-grid">
      <div id="saved-endpoints-container">
        <h3>Saved Endpoints</h3>
        <ul id="saved-endpoints-list" class="endpoint-list"></ul>
      </div>

      <div id="fetched-endpoints-container" style="display: none">
        <h3>Fetched Endpoints</h3>
        <ul id="fetched-endpoints-list" class="endpoint-list"></ul>
      </div>
    </div>
    <div id="error" class="error"></div>

    <script type="module">
      import Restinpieces from "./js/restinpieces.js";

      const rp = new Restinpieces({
        baseURL: "http://localhost:8080",
      });

      function renderEndpoints(endpoints, listElement, containerElement) {
        listElement.innerHTML = "";

        if (endpoints) {
          let html = "";
          for (const [key, value] of Object.entries(endpoints)) {
            const method = value.split(" ")[0].toLowerCase();
            const path = value
              .replace(/^GET|POST|PUT|DELETE|PATCH /, "")
              .trim();
            html += `
                        <li class="endpoint-item">
                            <span class="method ${method}">${method.toUpperCase()}</span>
                            <span>${path}</span>
                        </li>`;
          }
          listElement.innerHTML = html;
          containerElement.style.display = "block";
        } else {
          containerElement.style.display = "none";
        }
      }

      function showSavedEndpoints() {
        const endpoints = rp.store.endpoints.load();
        renderEndpoints(
          endpoints,
          document.getElementById("saved-endpoints-list"),
          document.getElementById("saved-endpoints-container"),
        );
      }

      function showFetchedEndpoints(endpoints) {
        renderEndpoints(
          endpoints,
          document.getElementById("fetched-endpoints-list"),
          document.getElementById("fetched-endpoints-container"),
        );
      }

      function getEndpoints() {
        const errorDiv = document.getElementById("error");
        errorDiv.textContent = "Loading...";

        // Show loading state
        rp.store.endpoints.save(null);
        showSavedEndpoints();

        rp.fetchEndpoints()
          .then((endpoints) => {
            errorDiv.textContent = "";

            if (!endpoints) {
              errorDiv.textContent = "No endpoints data received";
              return;
            }

            // Show the fresh endpoints on the right
            showFetchedEndpoints(endpoints);

            // Also update saved endpoints
            rp.store.endpoints.save(endpoints);
            showSavedEndpoints();
          })
          .catch((error) => {
            errorDiv.textContent = `Error: ${error.message}`;
            console.error(error);
          });
      }

      function checkAuthStatus() {
        const authText = document.getElementById("auth-text");

        if (rp.store.auth.isValid()) {
          authText.textContent = "✅ Authenticated";
          showSavedEndpoints();
        } else {
          authText.textContent = "❌ Not authenticated";
        }
      }

      // Initial load
      checkAuthStatus();
      showSavedEndpoints();

      // Event listener
      document
        .getElementById("get-endpoints-btn")
        .addEventListener("click", getEndpoints);
    </script>
  </body>
</html>
