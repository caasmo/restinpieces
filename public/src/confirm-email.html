<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Email Verification</title>
    <link rel="stylesheet" href="/css/restinpieces.css" />
  </head>
  <body class="confirm-email-page">
    <h1>Email Verification</h1>
    <div id="message" class="confirm-message confirm-loading">Verifying your email...</div>
    <div id="actions" class="confirm-hidden">
      <a href="/dashboard.html" class="confirm-button">Dashboard</a>
      <a href="/login.html" class="confirm-button">Login</a>
    </div>

    <script type="module">
      import Restinpieces from "/js/restinpieces.js";

      document.addEventListener("DOMContentLoaded", () => {
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get("token");
        const messageDiv = document.getElementById("message");
        const actionsDiv = document.getElementById("actions");

        if (!token) {
          showError("Missing verification token");
          return;
        }

        const rp = new Restinpieces({
          baseURL: "http://localhost:8080",
        });
        rp.confirmVerification({ token })
          .then((response) => {
            if (!response.message) {
              throw new Error("Invalid verification response: missing message");
            }
            showSuccess(response.message);
          })
          .catch((error) => {
            console.error("Verification failed:", error);
            let errorMessage = "Email verification failed";
            if (error.response) {
              errorMessage =
                error.response.message ||
                error.response.data?.message ||
                JSON.stringify(error.response, null, 2);
            } else if (error.message) {
              errorMessage = error.message;
            }
            showError(errorMessage);
          });

        function showSuccess(message) {
          messageDiv.className = "confirm-message confirm-success";
          messageDiv.textContent = message;
          actionsDiv.classList.remove("confirm-hidden");
        }

        function showError(message) {
          messageDiv.className = "confirm-message confirm-error";
          messageDiv.textContent = message;
          actionsDiv.classList.remove("confirm-hidden");
        }
      });
    </script>
  </body>
</html>
