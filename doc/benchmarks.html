<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Benchmark Comparison</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
        }
        #app {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        header {
            border-bottom: 1px solid #eaeaea;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }
        h1 {
            text-align: center;
        }
        h2 {
            margin-top: 40px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        #controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        select {
            padding: 8px;
            border-radius: 4px;
            border: 2px solid #ddd;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            table-layout: fixed;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            overflow-wrap: break-word;
        }
        th:first-child, td:first-child {
            width: 30%;
        }
        th {
            background-color: #f9f9f9;
        }
        .delta-pos {
            color: green;
        }
        .delta-neg {
            color: red;
        }
        .code-link {
            font-size: 0.9em;
            font-weight: normal;
            margin-left: 10px;
        }
        .code-link a {
            color: #0366d6;
            text-decoration: none;
        }
        .code-link a:hover {
            text-decoration: underline;
        }

        /* Color coding styles */
        .color-base { border-color: #aed6f1; }
        .color-compare { border-color: #a9dfbf; }

        .bg-base { background-color: #eaf2f8; }
        .bg-compare { background-color: #e9f7ef; }

        #legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            font-size: 0.9em;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .legend-color-box {
            width: 15px;
            height: 15px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <div id="app">
        <header>
            <h1>Benchmark Comparison</h1>
            <div id="controls">
                <label for="file1">Base:</label>
                <select id="file1"></select>
                <label for="file2">Compare:</label>
                <select id="file2"></select>
            </div>
            <div id="legend"></div>
        </header>
        <main id="results"></main>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const GITHUB_REPO = 'caasmo/restinpieces';
            const BENCHMARKS_PATH = '.github/benchmarks';
            const API_URL = `https://api.github.com/repos/${GITHUB_REPO}/contents/${BENCHMARKS_PATH}`;

            const file1Select = document.getElementById('file1');
            const file2Select = document.getElementById('file2');
            const resultsContainer = document.getElementById('results');
            const legendContainer = document.getElementById('legend');

            async function fetchJson(url) {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Failed to fetch ${url}: ${response.statusText}`);
                }
                return response.json();
            }

            function parseFilename(filename) {
                const match = filename.match(/benchmark-(\d{14})-(\w+)\.json/);
                if (!match) return null;
                return {
                    timestamp: match[1],
                    sha: match[2],
                    filename: filename
                };
            }

            function formatTimestamp(ts) {
                const match = ts.match(/^(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})$/);
                if (!match) return ts;
                const [, year, month, day, hour, minute, second] = match;
                return `${year}-${month}-${day} ${hour}:${minute}:${second}`;
            }

            function renderTable(packageData1, packageData2, packageName) {
                const benchmarks1 = new Map(packageData1.map(b => [b.name, b]));
                const benchmarks2 = new Map(packageData2.map(b => [b.name, b]));
                const allBenchmarkNames = new Set([...benchmarks1.keys(), ...benchmarks2.keys()]);

                const table = document.createElement('table');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Benchmark Name</th>
                            <th class="bg-base">ns/op (Base)</th>
                            <th class="bg-compare">ns/op (Compare)</th>
                            <th>Δ (ns/op)</th>
                            <th class="bg-base">B/op (Base)</th>
                            <th class="bg-compare">B/op (Compare)</th>
                            <th>Δ (B/op)</th>
                            <th class="bg-base">allocs/op (Base)</th>
                            <th class="bg-compare">allocs/op (Compare)</th>
                            <th>Δ (allocs/op)</th>
                        </tr>
                    </thead>
                `;
                const tbody = document.createElement('tbody');
                
                for (const name of Array.from(allBenchmarkNames).sort()) {
                    const b1 = benchmarks1.get(name);
                    const b2 = benchmarks2.get(name);
                    const row = document.createElement('tr');

                    function formatDelta(v1, v2) {
                        if (v1 === undefined || v2 === undefined || v1 === 0) return 'N/A';
                        const delta = ((v2 - v1) / v1) * 100;
                        const sign = delta > 0 ? '+' : '';
                        const colorClass = delta > 0 ? 'delta-neg' : 'delta-pos'; // Higher is worse
                        return `<span class="${colorClass}">${sign}${delta.toFixed(2)}%</span>`;
                    }

                    row.innerHTML = `
                        <td>${name.replace(/^Benchmark/, '')}</td>
                        <td class="bg-base">${b1 ? b1.ns_per_op.toFixed(2) : 'N/A'}</td>
                        <td class="bg-compare">${b2 ? b2.ns_per_op.toFixed(2) : 'N/A'}</td>
                        <td>${formatDelta(b1?.ns_per_op, b2?.ns_per_op)}</td>
                        <td class="bg-base">${b1 ? b1.b_per_op : 'N/A'}</td>
                        <td class="bg-compare">${b2 ? b2.b_per_op : 'N/A'}</td>
                        <td>${formatDelta(b1?.b_per_op, b2?.b_per_op)}</td>
                        <td class="bg-base">${b1 ? b1.allocs_per_op : 'N/A'}</td>
                        <td class="bg-compare">${b2 ? b2.allocs_per_op : 'N/A'}</td>
                        <td>${formatDelta(b1?.allocs_per_op, b2?.allocs_per_op)}</td>
                    `;
                    tbody.appendChild(row);
                }
                table.appendChild(tbody);
                return table;
            }

            async function renderComparison() {
                const file1Url = file1Select.value;
                const file2Url = file2Select.value;

                if (!file1Url || !file2Url) return;

                const file1Name = file1Select.options[file1Select.selectedIndex].text;
                const file2Name = file2Select.options[file2Select.selectedIndex].text;
                legendContainer.innerHTML = `
                    <div class="legend-item">
                        <div class="legend-color-box" style="background-color: #eaf2f8;"></div>
                        <span>Base: ${file1Name}</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color-box" style="background-color: #e9f7ef;"></div>
                        <span>Compare: ${file2Name}</span>
                    </div>
                `;

                resultsContainer.innerHTML = '<h2>Loading...</h2>';

                try {
                    const [data1, data2] = await Promise.all([
                        fetchJson(file1Url),
                        fetchJson(file2Url)
                    ]);

                    resultsContainer.innerHTML = '';

                    const allPackages = new Set([...Object.keys(data1), ...Object.keys(data2)]);

                    for (const pkg of Array.from(allPackages).sort()) {
                        const section = document.createElement('div');
                        const projectPath = pkg.replace('github.com/caasmo/restinpieces', '');
                        section.innerHTML = `
                            <h2>
                                ${pkg}
                                <span class="code-link">
                                    <a href="https://github.com/${GITHUB_REPO}/tree/main${projectPath}" target="_blank">view code</a>
                                </span>
                            </h2>
                        `;
                        
                        const table = renderTable(data1[pkg] || [], data2[pkg] || [], pkg);
                        section.appendChild(table);
                        resultsContainer.appendChild(section);
                    }
                } catch (error) {
                    resultsContainer.innerHTML = `<h2>Error: ${error.message}</h2>`;
                    console.error(error);
                }
            }

            async function main() {
                try {
                    file1Select.classList.add('color-base');
                    file2Select.classList.add('color-compare');

                    const files = await fetchJson(API_URL);
                    const benchmarkFiles = files
                        .map(f => parseFilename(f.name))
                        .filter(f => f)
                        .sort((a, b) => b.timestamp.localeCompare(a.timestamp));

                    if (benchmarkFiles.length === 0) {
                        resultsContainer.innerHTML = '<h2>No benchmark files found.</h2>';
                        return;
                    }

                    for (const file of benchmarkFiles) {
                        const fileData = files.find(f => f.name === file.filename);
                        if (fileData) {
                            const option1 = new Option(`${formatTimestamp(file.timestamp)} (${file.sha})`, fileData.download_url);
                            const option2 = new Option(`${formatTimestamp(file.timestamp)} (${file.sha})`, fileData.download_url);
                            file1Select.add(option1);
                            file2Select.add(option2);
                        }
                    }

                    if (benchmarkFiles.length >= 2) {
                        file1Select.selectedIndex = 1; // second newest
                        file2Select.selectedIndex = 0; // newest
                    } else if (benchmarkFiles.length === 1) {
                        file1Select.selectedIndex = 0;
                        file2Select.selectedIndex = 0;
                    }

                    file1Select.addEventListener('change', renderComparison);
                    file2Select.addEventListener('change', renderComparison);

                    renderComparison();

                } catch (error) {
                    resultsContainer.innerHTML = `<h2>Error loading benchmark list: ${error.message}</h2>`;
                    console.error(error);
                }
            }

            main();
        });
    </script>
</body>
</html>